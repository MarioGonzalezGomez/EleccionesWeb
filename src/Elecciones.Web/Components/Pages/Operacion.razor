@page "/operacion"
@implements IDisposable
@using Elecciones.Application.Abstractions
@using Elecciones.Application.Models
@inject IModuleLockService ModuleLockService
@inject IOperationService OperationService
@inject IEleccionesDataService DataService

<PageTitle>Operacion</PageTitle>

<h1>Operacion multioperador</h1>

<div class="mb-3">
    <label class="form-label">Operador</label>
    <input class="form-control" @bind="operatorId" />
</div>

@if (!string.IsNullOrWhiteSpace(feedbackMessage))
{
    <div class="alert @(feedbackIsError ? "alert-danger" : "alert-success")" role="alert">
        @feedbackMessage
    </div>
}

<div class="row g-4">
    <div class="col-12 col-xl-6">
        <h4>Bloqueo de modulos</h4>
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th>Modulo</th>
                    <th>Estado</th>
                    <th>Owner</th>
                    <th>Ultima accion (UTC)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var state in moduleStates)
                {
                    var mine = IsMine(state);
                    <tr>
                        <td>@state.Module</td>
                        <td>@(state.IsLocked ? "LOCKED" : "FREE")</td>
                        <td>@(string.IsNullOrWhiteSpace(state.Owner) ? "-" : state.Owner)</td>
                        <td>@FormatUtc(state.LastActionUtc)</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2"
                                    type="button"
                                    @onclick="() => Acquire(state.Module)"
                                    disabled="@(state.IsLocked && !mine)">
                                Lock
                            </button>
                            <button class="btn btn-sm btn-outline-secondary"
                                    type="button"
                                    @onclick="() => Release(state.Module)"
                                    disabled="@(!mine)">
                                Unlock
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="col-12 col-xl-6">
        <h4>Accion de control</h4>

        <div class="mb-2">
            <label class="form-label">Modulo</label>
            <select class="form-select" @bind="selectedModule">
                @foreach (var module in Enum.GetValues<GraphicModule>())
                {
                    <option value="@module">@module</option>
                }
            </select>
        </div>

        <div class="mb-2">
            <label class="form-label">Circunscripcion</label>
            <select class="form-select" @bind="selectedCircunscripcionCodigo">
                @foreach (var circ in circunscripciones)
                {
                    <option value="@circ.Codigo">@circ.Codigo - @circ.Nombre</option>
                }
            </select>
        </div>

        <div class="mb-2">
            <label class="form-label">Accion</label>
            <select class="form-select" @bind="selectedAction">
                @foreach (var action in Enum.GetValues<OperationActionType>())
                {
                    <option value="@action">@action</option>
                }
            </select>
        </div>

        <div class="mb-2">
            <label class="form-label">Destino TCP</label>
            <select class="form-select" @bind="selectedTarget">
                @foreach (var target in Enum.GetValues<GraphicsTarget>())
                {
                    <option value="@target">@target</option>
                }
            </select>
        </div>

        <div class="form-check mb-2">
            <input id="oficiales" class="form-check-input" type="checkbox" @bind="oficiales" />
            <label class="form-check-label" for="oficiales">Datos oficiales</label>
        </div>

        <div class="mb-3">
            <label class="form-label">Nombre CSV</label>
            <input class="form-control" @bind="exportName" />
        </div>

        <button class="btn btn-primary"
                type="button"
                @onclick="RunActionAsync"
                disabled="@(!CanExecute)">
            Ejecutar
        </button>
    </div>
</div>

@if (lastResult is not null)
{
    <hr />
    <h4>Resultado</h4>
    <p><strong>CSV:</strong> @lastResult.CsvPath</p>
    <p><strong>Signal:</strong> @lastResult.Signal</p>
    <p><strong>Targets:</strong> @(lastResult.DispatchedTargets.Count == 0 ? "None" : string.Join(", ", lastResult.DispatchedTargets))</p>
}

@code {
    private string operatorId = Environment.UserName;
    private string feedbackMessage = string.Empty;
    private bool feedbackIsError;

    private IReadOnlyList<ModuleLockInfo> moduleStates = [];
    private IReadOnlyList<CircunscripcionSummary> circunscripciones = [];

    private GraphicModule selectedModule = GraphicModule.Faldon;
    private OperationActionType selectedAction = OperationActionType.Enter;
    private GraphicsTarget selectedTarget = GraphicsTarget.Ipf;
    private string selectedCircunscripcionCodigo = string.Empty;
    private bool oficiales;
    private string exportName = "BrainStorm";

    private OperationResult? lastResult;

    protected override async Task OnInitializedAsync()
    {
        moduleStates = ModuleLockService.GetStates();
        ModuleLockService.LocksChanged += OnLocksChanged;

        circunscripciones = await DataService.GetCircunscripcionesAsync();
        selectedCircunscripcionCodigo = circunscripciones.FirstOrDefault()?.Codigo ?? string.Empty;
    }

    private bool CanExecute =>
        !string.IsNullOrWhiteSpace(operatorId)
        && !string.IsNullOrWhiteSpace(selectedCircunscripcionCodigo)
        && ModuleLockService.IsOwner(selectedModule, operatorId);

    private bool IsMine(ModuleLockInfo state)
    {
        return state.IsLocked && string.Equals(state.Owner, operatorId, StringComparison.OrdinalIgnoreCase);
    }

    private async Task RunActionAsync()
    {
        var request = new OperationRequest
        {
            OperatorId = operatorId.Trim(),
            Module = selectedModule,
            Action = selectedAction,
            Target = selectedTarget,
            CircunscripcionCodigo = selectedCircunscripcionCodigo,
            Oficiales = oficiales,
            ExportName = string.IsNullOrWhiteSpace(exportName) ? "BrainStorm" : exportName.Trim()
        };

        lastResult = await OperationService.ExecuteAsync(request);
        feedbackMessage = lastResult.Message;
        feedbackIsError = !lastResult.Success;
    }

    private void Acquire(GraphicModule module)
    {
        var ok = ModuleLockService.TryAcquire(module, operatorId.Trim());
        feedbackMessage = ok
            ? $"Module {module} locked by {operatorId.Trim()}."
            : $"Cannot lock module {module}. It is owned by another operator.";
        feedbackIsError = !ok;
    }

    private void Release(GraphicModule module)
    {
        var ok = ModuleLockService.Release(module, operatorId.Trim());
        feedbackMessage = ok
            ? $"Module {module} unlocked."
            : $"Cannot unlock module {module}. Only the owner can do it.";
        feedbackIsError = !ok;
    }

    private void OnLocksChanged()
    {
        _ = InvokeAsync(() =>
        {
            moduleStates = ModuleLockService.GetStates();
            StateHasChanged();
        });
    }

    private static string FormatUtc(DateTime? dt)
    {
        return dt.HasValue ? dt.Value.ToString("yyyy-MM-dd HH:mm:ss") : "-";
    }

    public void Dispose()
    {
        ModuleLockService.LocksChanged -= OnLocksChanged;
    }
}
