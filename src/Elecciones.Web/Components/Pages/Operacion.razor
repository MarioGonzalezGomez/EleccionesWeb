@page "/operacion"
@page "/operacion/{moduleHint}"
@implements IDisposable
@using Elecciones.Application.Abstractions
@using Elecciones.Application.Models
@inject IModuleLockService ModuleLockService
@inject IOperationService OperationService
@inject IEleccionesDataService DataService

<PageTitle>Operacion</PageTitle>

<h1>Operacion multioperador</h1>

@if (!string.IsNullOrWhiteSpace(feedbackMessage))
{
    <div class="alert @(feedbackIsError ? "alert-danger" : "alert-success")" role="alert">
        @feedbackMessage
    </div>
}

<div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
        <label class="form-label">Operador</label>
        <input class="form-control" @bind="operatorId" />
    </div>
    <div class="col-12 col-md-3">
        <label class="form-label">Tipo consulta</label>
        <select class="form-select" @bind="queryKind">
            @foreach (var kind in Enum.GetValues<SnapshotQueryKind>())
            {
                <option value="@kind">@kind</option>
            }
        </select>
    </div>
    <div class="col-12 col-md-3">
        <label class="form-label">Destino TCP</label>
        <select class="form-select" @bind="selectedTarget">
            @foreach (var target in Enum.GetValues<GraphicsTarget>())
            {
                <option value="@target">@target</option>
            }
        </select>
    </div>
    <div class="col-12 col-md-3">
        <div class="form-check mt-4">
            <input id="oficiales" class="form-check-input" type="checkbox" @bind="oficiales" />
            <label class="form-check-label" for="oficiales">Datos oficiales</label>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
        <label class="form-label">Circunscripcion</label>
        <select class="form-select" @bind="selectedCircunscripcionCodigo" disabled="@(queryKind != SnapshotQueryKind.Circunscripcion)">
            @foreach (var circ in circunscripciones)
            {
                <option value="@circ.Codigo">@circ.Codigo - @circ.Nombre</option>
            }
        </select>
    </div>
    <div class="col-12 col-md-4">
        <label class="form-label">Codigo autonomia</label>
        <input class="form-control" @bind="autonomiaCodigo" placeholder="Ej: 02" disabled="@(!RequiresAutonomia)" />
    </div>
    <div class="col-12 col-md-4">
        <label class="form-label">Codigo partido</label>
        <input class="form-control" @bind="partidoCodigo" placeholder="Ej: 00001" disabled="@(!RequiresPartido)" />
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12 col-md-8">
        <label class="form-label">Nombre CSV</label>
        <input class="form-control" @bind="exportName" />
    </div>
    <div class="col-12 col-md-4">
        <div class="form-check mt-4">
            <input id="includeZero" class="form-check-input" type="checkbox" @bind="includeZeroSeats" />
            <label class="form-check-label" for="includeZero">Incluir partidos con 0 escanos</label>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12 col-xl-5">
        <h4>Bloqueo de modulos</h4>
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th>Modulo</th>
                    <th>Estado</th>
                    <th>Owner</th>
                    <th>Ultima accion (UTC)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var state in moduleStates)
                {
                    var mine = IsMine(state);
                    <tr>
                        <td>@state.Module</td>
                        <td>@(state.IsLocked ? "LOCKED" : "FREE")</td>
                        <td>@(string.IsNullOrWhiteSpace(state.Owner) ? "-" : state.Owner)</td>
                        <td>@FormatUtc(state.LastActionUtc)</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2"
                                    type="button"
                                    @onclick="() => Acquire(state.Module)"
                                    disabled="@(state.IsLocked && !mine)">
                                Lock
                            </button>
                            <button class="btn btn-sm btn-outline-secondary"
                                    type="button"
                                    @onclick="() => Release(state.Module)"
                                    disabled="@(!mine)">
                                Unlock
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="col-12 col-xl-7">
        <h4>Botonera por modulo</h4>

        @foreach (var module in Enum.GetValues<GraphicModule>())
        {
            if (!ShowModule(module))
            {
                continue;
            }

            var owned = ModuleLockService.IsOwner(module, operatorId);
            <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>@module</strong>
                    <span class="badge @(owned ? "bg-success" : "bg-secondary")">@(owned ? "OWNED" : "READ ONLY")</span>
                </div>

                <div class="mb-2">
                    <label class="form-label form-label-sm">Escena</label>
                    <select class="form-select form-select-sm" @bind="selectedScenes[module]" disabled="@(!owned)">
                        @foreach (var scene in GetScenes(module))
                        {
                            <option value="@scene">@scene</option>
                        }
                    </select>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-info" @onclick="() => RunQuickActionAsync(module, OperationActionType.Prepare)" disabled="@(!owned)">PREPARA</button>
                    <button class="btn btn-sm btn-success" @onclick="() => RunQuickActionAsync(module, OperationActionType.Enter)" disabled="@(!owned)">ENTRA</button>
                    <button class="btn btn-sm btn-primary" @onclick="() => RunQuickActionAsync(module, OperationActionType.Update)" disabled="@(!owned)">ACTUALIZA</button>
                    <button class="btn btn-sm btn-warning" @onclick="() => RunQuickActionAsync(module, OperationActionType.Exit)" disabled="@(!owned)">SALE</button>
                    <button class="btn btn-sm btn-danger" @onclick="() => RunQuickActionAsync(module, OperationActionType.Reset)" disabled="@(!owned)">RESET</button>
                </div>
            </div>
        }
    </div>
</div>

@if (lastResult is not null)
{
    <hr />
    <h4>Resultado</h4>
    <p><strong>CSV:</strong> @lastResult.CsvPath</p>
    <p><strong>Signal:</strong></p>
    <pre class="p-2 border rounded bg-light">@lastResult.Signal</pre>
    <p><strong>Targets:</strong> @(lastResult.DispatchedTargets.Count == 0 ? "None" : string.Join(", ", lastResult.DispatchedTargets))</p>
}

@code {
    private string operatorId = Environment.UserName;
    private string feedbackMessage = string.Empty;
    private bool feedbackIsError;

    private IReadOnlyList<ModuleLockInfo> moduleStates = [];
    private IReadOnlyList<CircunscripcionSummary> circunscripciones = [];

    private GraphicsTarget selectedTarget = GraphicsTarget.Ipf;
    private SnapshotQueryKind queryKind = SnapshotQueryKind.Circunscripcion;
    private string selectedCircunscripcionCodigo = string.Empty;
    private string autonomiaCodigo = string.Empty;
    private string partidoCodigo = string.Empty;
    private bool includeZeroSeats;
    private bool RequiresAutonomia => queryKind is SnapshotQueryKind.MasVotadosProvincias or SnapshotQueryKind.PartidoProvincias;
    private bool RequiresPartido => queryKind is SnapshotQueryKind.PartidoAutonomias or SnapshotQueryKind.PartidoProvincias;

    private bool oficiales;
    private string exportName = "BrainStorm";

    private readonly Dictionary<GraphicModule, string[]> moduleScenes = new()
    {
        [GraphicModule.Faldon] = ["Escrutinio", "Sondeo", "TICKER", "Pactometro", "SEDES", "CuentaAtras"],
        [GraphicModule.Carton] = ["PARTICIPACION", "CCAA_CARTONES", "CARRUSEL", "MAYORIAS", "CARTON_PARTIDOS", "ULTIMO_ESCANO"],
        [GraphicModule.Superfaldon] = ["SUPERFALDON", "ULTIMOESCANO", "SEDES"]
    };

    private readonly Dictionary<GraphicModule, string> selectedScenes = new();

    private OperationResult? lastResult;
    [Parameter] public string? moduleHint { get; set; }

    protected override async Task OnInitializedAsync()
    {
        moduleStates = ModuleLockService.GetStates();
        ModuleLockService.LocksChanged += OnLocksChanged;

        circunscripciones = await DataService.GetCircunscripcionesAsync();
        selectedCircunscripcionCodigo = circunscripciones.FirstOrDefault()?.Codigo ?? string.Empty;

        foreach (var module in Enum.GetValues<GraphicModule>())
        {
            selectedScenes[module] = GetScenes(module).FirstOrDefault() ?? string.Empty;
        }
    }

    private IEnumerable<string> GetScenes(GraphicModule module)
    {
        return moduleScenes.TryGetValue(module, out var scenes) ? scenes : ["CONTROL"];
    }

    
    private bool ShowModule(GraphicModule module)
    {
        if (string.IsNullOrWhiteSpace(moduleHint))
        {
            return true;
        }

        return string.Equals(moduleHint, module.ToString(), StringComparison.OrdinalIgnoreCase);
    }
    private bool IsMine(ModuleLockInfo state)
    {
        return state.IsLocked && string.Equals(state.Owner, operatorId, StringComparison.OrdinalIgnoreCase);
    }

    private async Task RunQuickActionAsync(GraphicModule module, OperationActionType action)
    {
        if (!ModuleLockService.IsOwner(module, operatorId))
        {
            feedbackMessage = $"No puedes operar {module}. Bloquealo primero con tu usuario.";
            feedbackIsError = true;
            return;
        }

        var request = new OperationRequest
        {
            OperatorId = operatorId.Trim(),
            Module = module,
            Scene = selectedScenes.TryGetValue(module, out var scene) ? scene : string.Empty,
            Action = action,
            Target = selectedTarget,
            Oficiales = oficiales,
            ExportName = string.IsNullOrWhiteSpace(exportName) ? "BrainStorm" : exportName.Trim(),
            Query = BuildQuery()
        };

        lastResult = await OperationService.ExecuteAsync(request);
        feedbackMessage = lastResult.Message;
        feedbackIsError = !lastResult.Success;
    }

    private SnapshotQuery BuildQuery()
    {
        return new SnapshotQuery
        {
            Kind = queryKind,
            CircunscripcionCodigo = selectedCircunscripcionCodigo,
            AutonomiaCodigo = autonomiaCodigo.Trim(),
            PartidoCodigo = partidoCodigo.Trim(),
            IncludeZeroSeats = includeZeroSeats
        };
    }

    private void Acquire(GraphicModule module)
    {
        var ok = ModuleLockService.TryAcquire(module, operatorId.Trim());
        feedbackMessage = ok
            ? $"Modulo {module} bloqueado por {operatorId.Trim()}."
            : $"No se puede bloquear {module}. Ya tiene owner.";
        feedbackIsError = !ok;
    }

    private void Release(GraphicModule module)
    {
        var ok = ModuleLockService.Release(module, operatorId.Trim());
        feedbackMessage = ok
            ? $"Modulo {module} desbloqueado."
            : $"No se puede desbloquear {module}. Solo el owner puede hacerlo.";
        feedbackIsError = !ok;
    }

    private void OnLocksChanged()
    {
        _ = InvokeAsync(() =>
        {
            moduleStates = ModuleLockService.GetStates();
            StateHasChanged();
        });
    }

    private static string FormatUtc(DateTime? dt)
    {
        return dt.HasValue ? dt.Value.ToString("yyyy-MM-dd HH:mm:ss") : "-";
    }

    public void Dispose()
    {
        ModuleLockService.LocksChanged -= OnLocksChanged;
    }
}


